# frozen_string_literal: true

require 'test_helper'

module MixinBot::Utils
  class TestCrypto < Minitest::Test
    def setup
    end

    def test_utils_generate_unique_uuid
      uuid1 = '67d46d1b-0a46-4821-bb05-71efb9f90335'
      uuid2 = '073153fb-a5a3-4724-8658-fc9073e5510c'
      uuid3 = '5c749a9f-c45c-4f5c-a80e-09f3b3473cf7'

      assert MixinBot.utils.generate_unique_uuid(uuid1, uuid2) == '42a76a3b-775f-3ee6-baeb-3f76224f8deb'
      assert MixinBot.utils.generate_unique_uuid(uuid2, uuid1) == '42a76a3b-775f-3ee6-baeb-3f76224f8deb'
      assert MixinBot.utils.unique_uuid(uuid1, uuid2, uuid3) == 'f681e720-4981-3497-add1-4d90eabd7dce'
    end

    def test_generate_group_conversation_id
      owner_id = 'c8cb0ac7-d456-4341-be66-0b143aa09922'
      group_name = 'Mixin Rocks'
      participants = %w[
        f937ca18-d1ff-46f5-99e8-e23fbd6fd5f2
        0e0a20c8-31b8-4093-81b8-9cebd9bc8afc
        8391e472-cdbe-4704-be1f-7d184635b885
        831fdb67-13ed-4dc5-ac64-dda89aeda2bb
        f7ff9dde-18c2-4375-8097-b364068b120e
        088c1e3e-1f07-4065-85b5-6b49b4370d32
      ]
      random_id = '01d21e2c-76f5-4940-8ea0-9b7f21728674'
      expected_group_id = '5dac944e-2037-31b4-bbd9-e5fd3ffe571e'

      group_id = MixinBot.utils.generate_group_conversation_id(
        user_ids: participants,
        name: group_name,
        owner_id:,
        random_id:
      )

      assert_equal expected_group_id, group_id
    end

    def test_utils_generate_trace_from_hash
      hash = '9694efdb97561af52104a112d9d836ea7972a2f97536fead2e5a9a1ffe0ba6ab'
      trace_id = '9fd4e5b8-7dba-3145-a2a6-914930a77cb7'

      assert MixinBot.utils.generate_trace_from_hash(hash) == trace_id
    end

    def test_utils_generate_rsa_key
      res = MixinBot.utils.generate_rsa_key

      assert res.key?(:public_key)
    end

    def test_utils_generate_ed25519_key
      res = MixinBot.utils.generate_ed25519_key

      assert res.key?(:public_key)
    end

    def test_utils_derive_ghost_key
      key = JOSE::JWA::Ed25519.keypair
      r_key = key[1][...32]
      r_public_key = MixinBot.utils.shared_public_key r_key

      spend_key = JOSE::JWA::Ed25519.keypair[1][...32]
      spend_public_key = MixinBot.utils.shared_public_key spend_key

      view_key = JOSE::JWA::Ed25519.keypair[1][...32]
      view_public_key = MixinBot.utils.shared_public_key view_key

      output_index = 1

      ghost_public_key = MixinBot.utils.derive_ghost_public_key r_key, spend_public_key, view_public_key, output_index

      ghost_private_key1 = MixinBot.utils.derive_ghost_private_key r_public_key, spend_key, view_key, output_index
      assert_equal ghost_public_key, MixinBot.utils.shared_public_key(ghost_private_key1)

      ghost_private_key2 = MixinBot.utils.derive_ghost_private_key spend_public_key, r_key, view_key, output_index
      assert_equal ghost_public_key, MixinBot.utils.shared_public_key(ghost_private_key2)
    end

    def test_utils_sign
      msg_hex = '77770005a99c2e0e2b1da4d648755ef19bd95139acbbe6564cfb06dec7cd34931ca72cdc008c8671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800000000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800010000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800020000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800030000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800040000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800050000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800060000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800070000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800080000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800090000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88000a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88000b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88000c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88000d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88000e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88000f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800100000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800110000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800120000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800130000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800140000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800150000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800160000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800170000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800180000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800190000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88001a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88001b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88001c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88001d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88001e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88001f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800200000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800210000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800220000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800230000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800240000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800250000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800260000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800270000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800280000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800290000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88002a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88002b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88002c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88002d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88002e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88002f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800300000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800310000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800320000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800330000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800340000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800350000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800360000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800370000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800380000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800390000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88003a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88003b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88003c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88003d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88003e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88003f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800400000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800410000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800420000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800430000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800440000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800450000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800460000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800470000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800480000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800490000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88004a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88004b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88004c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88004d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88004e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88004f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800500000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800510000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800520000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800530000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800540000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800550000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800560000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800570000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800580000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800590000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88005a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88005b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88005c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88005d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88005e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88005f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800600000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800610000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800620000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800630000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800640000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800650000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800660000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800670000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800680000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800690000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88006a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88006b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88006c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88006d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88006e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88006f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800700000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800710000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800720000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800730000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800740000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800750000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800760000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800770000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800780000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800790000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88007a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88007b0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88007c0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88007d0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88007e0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88007f0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800800000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800810000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800820000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800830000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800840000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800850000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800860000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800870000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800880000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a8800890000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88008a0000000000008671a7459435d64702860d6016b98be65ddbb9c6e444abc57c9b2c70c8de2a88008b000000000000000100000003d59f800001dca1ab3d1d7c28bd39641b30c6f2a2d52cf39b5f08427a2f9bfa46b20167d3448728367dc946de9d7a9756048bd5f4595fb0412f45b2f9e88547727b676ee0c80003fffe010000000000000032414146535255593947534133357443727641506754616e615648536f4e34784b797463386151667138623845623468544f410000'
      key_hex = '10abc9ffcbb5275f39f0f8cca85db0b721336697e488885cbe489cac902e9a03'

      msg = [msg_hex].pack('H*')
      key = [key_hex].pack('H*')

      signature = MixinBot.utils.sign(msg, key:)
      assert_equal signature.bytesize, 64
    end
  end
end
